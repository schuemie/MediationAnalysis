---
title: "Evaluation of methods for synthesizing interaction effect estimates"
author: "Martijn Schuemie, Yong Chen"
date: "`r Sys.Date()`"
output: 
  word_document: 
    toc: yes
    number_sections: yes
bibliography: Design.bib
---

```{r setup, include=FALSE,warning=FALSE}
library(dplyr)
library(knitr)

source("PrintCohortDefinitions.R")

```

# Introduction



# Example mediation analysis

We therefore formulate an example comparative cohort study as follows:

- **Target**: New users of diclofenac (a non-selective NSAID)
- **Comparator**: New users of warfarin
- **Outcome**: MACE
- **Mediator**: Major bleeding
- **Time at risk**: On-treatment: starting on the day of treatment initiation, ending when treatment is stopped (for at least 30 days).
- **Model**: Cox proportional hazards

Cohort definitions of the target, comparator, and outcome are provided in Appendix A. 

We will require at least 365 days of continuous observation prior to the index date.

Large-scale propensity scores (PS) will be fitted using the standard set of features, including all drugs, conditions, procedures, measurements, and observations in the year prior to index date, as well as demographics. We will use variable ratio PS matching [ref Rassen].

Large-scale mediator risk scores (MRS) will be fitted using the standard set of features, including all drugs, conditions, procedures, measurements, and observations in the year prior to index date, as well as demographics.

A set of 50 negative control outcomes, outcomes believed to be caused by neither the target nor the comparator, has been defined. (See Appendix B). We assume that these controls are negative both for the direct effect and the mediated effect.


# Evaluation of evidence synthesis methods

The example study will be executed across the databases described in the 'Data sources' section. Various approaches for likelihood profiling will be applied to produce summary estimates for the main effect and the interaction effect, both for the outcome of interest (GI bleed) as well as the negative control outcomes. 

The summary estimates for GI bleed will be compared with the gold standard, produced by pooling the data (stratified by data source).

The negative control summary estimates will be used to estimate residual systematic error.


# Data sources

The DatabaseDiagnostics package was used to select those databases that appear to have the elements needed for the example estimation questions:


# References

<div id="refs"></div>

# Appendix A: Cohort Definitions

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
cohortDefinitionSet <- readRDS("CohortDefinitionSet.rds")
```

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
json <- cohortDefinitionSet$json[cohortDefinitionSet$cohortId == 16329]
printCohortDefinitionFromNameAndJson("Target", json)
```

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
json <- cohortDefinitionSet$json[cohortDefinitionSet$cohortId == 16330]
printCohortDefinitionFromNameAndJson("Comparator", json)
```

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
json <- cohortDefinitionSet$json[cohortDefinitionSet$cohortId == 16484]
printCohortDefinitionFromNameAndJson("Mediator", json)
```

```{r echo=FALSE, results="asis", warning=FALSE, message=FALSE}
json <- cohortDefinitionSet$json[cohortDefinitionSet$cohortId == 11024]
printCohortDefinitionFromNameAndJson("Outcome", json)
```

# Appendix B: Negative controls
```{r echo=FALSE, warning=FALSE, message=FALSE}
readr::read_csv(
    file = "NegativeControls.csv",
    show_col_types = FALSE
  ) %>%
  arrange(conceptName) %>%
  select("Concept ID" = "conceptId", Name = "conceptName") %>%
  kable(linesep = "", booktabs = TRUE, longtable = TRUE)
```